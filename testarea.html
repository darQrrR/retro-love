<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Document</title>

		<style>
			body {
				background-color: #22021d;
			}
			@font-face {
				font-family: 'Kommondore';
				font-weight: 400;
				font-style: normal;
				font-display: swap;
				src: url('/assets/fonts/Kommondore-1.5.woff2');
			}

			.output {
				display: block;
				width: 60%;
				margin: 100px auto;
				padding: 60px 20px;
				font-family: Kommondore;
				font-size: 35px;
				background-color: rgb(17, 137, 158);
				border: 5px solid rgb(235, 236, 220);
				color: rgb(235, 236, 220);
			}
		</style>
	</head>
	<body>
		<div class="output"></div>
	</body>

	<script>
		const variables = {
			A: 123,
			AB: 9,
			B: 2,
			C: 3,
			C$: 'TEST',
			'D%': 3.1415,
		};
		const command =
			'"HELLO " + "WORLD"; A + 2.1; 40 + 2 4 * 3; C$; A, B, D%';
		const outputdiv = document.querySelector('.output');
		const operators = ['+', '-', '*', '/', '%'];
		const outputSeparators = [';', ','];
		const types = ['$', '%'];
		let outputs = [];
		let stringmode = false;
		let nummode = false;
		let varmode = false;
		let buffer = '';
		let output = '';

		console.log(command);

		// tokenize command
		for (i = 0; i <= command.length; i++) {
			const char = command[i];

			// turn stringmode on
			if (char === '"' && !stringmode) {
				stringmode = true;
				continue;
			}

			// turn stringmode off
			if (char === '"' && stringmode) {
				outputs.push({ value: buffer, type: 'string' });
				stringmode = false;
				buffer = '';
				continue;
			}

			// run stringmode
			if (stringmode) {
				buffer += char;
				continue;
			}

			// ignore spaces if not in stringmode
			if (!stringmode && char === ' ') {
				continue;
			}

			// turn nummode on
			if (/^[0-9.]$/.test(char) && !nummode) {
				nummode = true;
				buffer += char;
				continue;
			}

			// turn nummode off
			if (!/^[0-9.]$/.test(char) && nummode) {
				outputs.push({ value: Number(buffer), type: 'number' });
				buffer = '';
				nummode = false;
			}

			// run nummode
			if (/^[0-9.]$/.test(char) && nummode) {
				// if decimal is already set, start new number
				if (char === '.' && buffer.includes('.')) {
					outputs.push({ value: Number(buffer), type: 'number' });
					buffer = char;
					continue;
				}

				buffer += char;
				continue;
			}

			// turn varmode on
			if (/^[A-Za-z]$/.test(char) && !varmode) {
				varmode = true;
				buffer += char;
				continue;
			}

			// turn varmode off
			if ((!/^[A-Za-z]$/.test(char) || types.includes(char)) && varmode) {
				if (types.includes(char)) {
					buffer += char;
					outputs.push({ value: buffer, type: 'variable' });
					buffer = '';
					varmode = false;
					continue;
				}

				outputs.push({ value: buffer, type: 'variable' });
				buffer = '';
				varmode = false;
			}

			// run varmode
			if (/^[A-Za-z]$/.test(char) && varmode) {
				buffer += char;
				continue;
			}

			// operators
			if (operators.includes(char)) {
				outputs.push({ value: char, type: 'operator' });
			}

			// separators
			if (outputSeparators.includes(char)) {
				outputs.push({ value: char, type: 'separator' });
			}
		}

		// variable substitution
		for (let i = 0; i < outputs.length; i++) {
			const o = outputs[i];
			if (o.type === 'variable') {
				outputs[i] = {
					value: variables[o.value],
					type: typeof variables[o.value],
				};
			}
		}

		// parse tokenized command
		let calculation = null;

		for (let i = 0; i < outputs.length; i++) {
			const o = outputs[i];
			console.log(o);

			if (o.type === 'string') {
				output += o.value;
				continue;
			}

			if (calculation && o.type === 'separator') {
				// execute calculation
				output += eval(calculation);
				output += ' ';
				calculation = null;
				continue;
			}

			if (o.type === 'separator') {
				output += ' ';
			}

			if (o.type === 'number') {
				if (calculation) {
					calculation += o.value;
					continue;
				}
				if (outputs[i + 1] && outputs[i + 1].type === 'operator') {
					calculation = o.value;
					continue;
				}
				output += o.value;
				continue;
			}

			if (o.type === 'operator') {
				if (calculation) {
					calculation += o.value;
					continue;
				}
			}

			if (calculation) {
				console.log(calculation);
			}
			//output += o.value;
		}

		outputdiv.innerHTML = output;
	</script>
</html>
